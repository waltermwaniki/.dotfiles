#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""Dotfiles management utility - deployed by bootstrap.py"""

import argparse
import json
import subprocess
import sys
from pathlib import Path

def load_bootstrap_state():
    """Load bootstrap state to get target directory."""
    state_file = Path.cwd() / ".bootstrap.state.json"
    if state_file.exists():
        try:
            with open(state_file, 'r') as f:
                return json.load(f)
        except:
            pass
    return {}

def main():
    parser = argparse.ArgumentParser(description="Manage dotfiles with stow")
    parser.add_argument("action", choices=["status", "restow", "conflicts"], help="Action to perform")
    args = parser.parse_args()
    
    state = load_bootstrap_state()
    target = state.get("target_directory", Path.home())
    
    if args.action == "status":
        print(f"Dotfiles target: {target}")
        print(f"Last stow: {state.get('last_stow', 'Never')}")
    elif args.action == "restow":
        print(f"Re-applying dotfiles to {target}")
        result = subprocess.run(["stow", "-Rvt", str(target), "home"])
        sys.exit(result.returncode)
    elif args.action == "conflicts":
        print("Checking for conflicts...")
        result = subprocess.run(["stow", "-nvt", str(target), "home"], capture_output=True, text=True)
        if "cannot stow" in result.stderr:
            print("Conflicts found:")
            print(result.stderr)
        else:
            print("No conflicts detected.")

if __name__ == "__main__":
    main()
