#!/usr/bin/env bash

# dotty - Simple dotfiles management using GNU Stow
# Supports macOS, Ubuntu/Debian, Rocky/RHEL, and WSL

set -e

# Configuration
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
DOTFILES_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
TARGET_DIR="${HOME}"
PACKAGE="home"
BIN_DIR="${HOME}/.local/bin"

# Colors
BLUE='\033[1;34m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
RESET='\033[0m'

say() { echo -e "${BLUE}===>${RESET} $1"; }
success() { echo -e "${GREEN}[success]${RESET} $1"; }
warn() { echo -e "${YELLOW}[warn]${RESET} $1"; }
error() { echo -e "${RED}[error]${RESET} $1" >&2; }

# Check if stow is installed, attempt to install if not
check_stow() {
    if command -v stow >/dev/null 2>&1; then
        return 0
    fi

    warn "GNU Stow is not installed. Attempting to install..."

    if [[ "$OSTYPE" == "darwin"* ]]; then
        if command -v brew >/dev/null 2>&1; then
            say "Installing stow via Homebrew..."
            brew install stow
        else
            error "Homebrew not found. Please install Homebrew first: https://brew.sh"
            exit 1
        fi
    elif [ -f /etc/os-release ]; then
        . /etc/os-release
        if [[ "$ID" == "ubuntu" || "$ID" == "debian" || "$ID_LIKE" == *"debian"* ]]; then
            say "Installing stow via apt-get..."
            sudo apt-get update && sudo apt-get install -y stow
        elif [[ "$ID" == "rocky" || "$ID" == "rhel" || "$ID" == "centos" || "$ID_LIKE" == *"rhel"* ]]; then
            say "Installing stow via dnf..."
            if ! sudo dnf install -y stow; then
                say "Stow not found in default repos. Attempting to enable EPEL..."
                sudo dnf install -y epel-release
                sudo dnf install -y stow
            fi
        else
            error "Unsupported Linux distribution: $ID"
            echo "Please install GNU Stow manually."
            exit 1
        fi
    else
        error "Unsupported OS. Please install GNU Stow manually."
        exit 1
    fi

    if command -v stow >/dev/null 2>&1; then
        success "GNU Stow installed successfully!"
    else
        error "Failed to install GNU Stow."
        exit 1
    fi
}

cmd_status() {
    check_stow
    say "Checking dotfiles status..."

    # Check for broken symlinks
    say "Checking for broken symlinks..."
    find "$TARGET_DIR" -maxdepth 2 -type l ! -exec test -e {} \; -print | grep -v "Library/Containers" || true

    say "Running stow dry-run..."
    stow -n -v -d "$DOTFILES_DIR" -t "$TARGET_DIR" "$PACKAGE" 2>&1 | grep -v "LINK" || true
}

cmd_sync() {
    check_stow
    local args="-v -R"

    if [[ "$1" == "--force" ]]; then
        args="$args --adopt"
        warn "Force mode enabled: Adopting existing files into repo."
    fi

    say "Applying dotfiles..."
    stow $args -d "$DOTFILES_DIR" -t "$TARGET_DIR" "$PACKAGE"
    success "Dotfiles applied!"
}

cmd_clean() {
    check_stow
    say "Removing dotfiles symlinks..."
    stow -D -v -d "$DOTFILES_DIR" -t "$TARGET_DIR" "$PACKAGE"
    success "Dotfiles removed!"
}

cmd_install() {
    say "Installing dotty to $BIN_DIR..."
    mkdir -p "$BIN_DIR"

    if [ -L "$BIN_DIR/dotty" ]; then
        rm "$BIN_DIR/dotty"
    fi

    ln -s "$DOTFILES_DIR/dotty" "$BIN_DIR/dotty"
    success "Installed dotty to $BIN_DIR/dotty"

    if [[ ":$PATH:" != *":$BIN_DIR:"* ]]; then
        warn "$BIN_DIR is not in your PATH."
        echo "Add the following to your shell config:"
        echo "export PATH=\"\$HOME/.local/bin:\$PATH\""
    fi

    check_stow
}

usage() {
    echo "Usage: dotty [command] [options]"
    echo ""
    echo "Commands:"
    echo "  status      Check status of dotfiles (default)"
    echo "  sync        Apply dotfiles (use --force to adopt existing files)"
    echo "  clean       Remove dotfiles symlinks"
    echo "  install     Install dotty to ~/.local/bin"
    echo ""
}

# Main
case "$1" in
    status)
        cmd_status
        ;;
    sync|apply)
        cmd_sync "$2"
        ;;
    clean|unlink)
        cmd_clean
        ;;
    install)
        cmd_install
        ;;
    help|--help|-h)
        usage
        ;;
    "")
        cmd_status
        ;;
    *)
        error "Unknown command: $1"
        usage
        exit 1
        ;;
esac
